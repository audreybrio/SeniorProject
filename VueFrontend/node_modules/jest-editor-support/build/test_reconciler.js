"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

require("core-js/modules/es.array.for-each.js");

require("core-js/modules/web.dom-collections.for-each.js");

require("core-js/modules/es.function.name.js");

require("core-js/modules/es.array.map.js");

require("core-js/modules/es.string.trim.js");

require("core-js/modules/es.regexp.exec.js");

require("core-js/modules/es.string.split.js");

require("core-js/modules/es.array.includes.js");

require("core-js/modules/es.string.includes.js");

require("core-js/modules/es.string.replace.js");

require("core-js/modules/es.array.join.js");

require("core-js/modules/es.array.splice.js");

require("core-js/modules/es.parse-int.js");

require("core-js/modules/es.array.find.js");

require("core-js/modules/es.object.define-property.js");

var _path = _interopRequireDefault(require("path"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

/**
 *  You have a Jest test runner watching for changes, and you have
 *  an extension that wants to know where to show errors after file parsing.
 *
 *  This class represents the state between runs, keeping track of passes/fails
 *  at a file level, generating useful error messages and providing a nice API.
 */
var TestReconciler = /*#__PURE__*/function () {
  function TestReconciler() {
    _classCallCheck(this, TestReconciler);

    this.fileStatuses = {};
  } // the processed test results will be returned immediately instead of saved in
  // instance properties. This is 1) to prevent race condition 2) the data is already
  // stored in the this.fileStatuses, no dup is better 3) client will most likely need to process
  // all the results anyway.


  _createClass(TestReconciler, [{
    key: "updateFileWithJestStatus",
    value: function updateFileWithJestStatus(results) {
      var _this = this;

      // Loop through all files inside the report from Jest
      var statusList = [];
      results.testResults.forEach(function (file) {
        // Did the file pass/fail?
        var status = _this.statusToReconcilationState(file.status); // Create our own simpler representation


        var fileStatus = {
          assertions: _this.mapAssertions(file.name, file.assertionResults),
          file: file.name,
          message: file.message,
          status: status
        };
        _this.fileStatuses[file.name] = fileStatus;
        statusList.push(fileStatus);
      });
      return statusList;
    }
    /**
     * remove jest status of the test file from the cached results
     * @param {string} fileName
     */

  }, {
    key: "removeTestFile",
    value: function removeTestFile(fileName) {
      delete this.fileStatuses[fileName];
    } // A failed test also contains the stack trace for an `expect`
    // we don't get this as structured data, but what we get
    // is useful enough to make it for ourselves

  }, {
    key: "mapAssertions",
    value: function mapAssertions(filename, assertions) {
      var _this2 = this;

      // convert jest location (column is 0-based and line is 1-based) to all 0-based location used internally in this package

      /* eslint-disable no-param-reassign */
      var convertJestLocation = function convertJestLocation(jestLocation) {
        if (jestLocation) {
          jestLocation.line -= 1;
        }

        return jestLocation;
      }; // Is it jest < 17? e.g. Before I added this to the JSON


      if (!assertions) {
        return [];
      } // Change all failing assertions into structured data


      return assertions.map(function (assertion) {
        // Failure messages seems to always be an array of one item
        var message = assertion.failureMessages && assertion.failureMessages[0];
        var _short = null;
        var terse = null;
        var line = null;
        var location = convertJestLocation(assertion.location); // output from jest --testLocationInResults (https://jestjs.io/docs/en/cli#testlocationinresults)

        if (message) {
          // Just the first line, with little whitespace
          _short = message.split('   at', 1)[0].trim(); // this will show inline, so we want to show very little

          terse = _this2.sanitizeShortErrorMessage(_short);
          line = _this2.lineOfError(message, filename);
        }

        return {
          line: line,
          message: message || '',
          shortMessage: _short,
          status: _this2.statusToReconcilationState(assertion.status),
          terseMessage: terse,
          title: assertion.title,
          location: location,
          fullName: assertion.fullName,
          ancestorTitles: assertion.ancestorTitles
        };
      });
    } // Do everything we can to try make a one-liner from the error report

  }, {
    key: "sanitizeShortErrorMessage",
    value: function sanitizeShortErrorMessage(string) {
      if (string.includes('does not match stored snapshot')) {
        return 'Snapshot has changed';
      }

      if (string.includes('New snapshot was not written')) {
        return 'New snapshot is ready to write';
      }

      return string.split('\n').splice(2).join('').replace(/\s\s+/g, ' ').replace('Received:', ', Received:').split('Difference:')[0];
    } // Pull the line out from the stack trace

  }, {
    key: "lineOfError",
    value: function lineOfError(message, filePath) {
      var filename = _path["default"].basename(filePath);

      var restOfTrace = message.split(filename, 2)[1];
      return restOfTrace ? parseInt(restOfTrace.split(':')[1], 10) : null;
    }
  }, {
    key: "statusToReconcilationState",
    value: function statusToReconcilationState(status) {
      switch (status) {
        case 'passed':
          return 'KnownSuccess';

        case 'failed':
          return 'KnownFail';

        case 'pending':
          return 'KnownSkip';

        case 'todo':
          return 'KnownTodo';

        default:
          return 'Unknown';
      }
    }
  }, {
    key: "stateForTestFile",
    value: function stateForTestFile(file) {
      var results = this.fileStatuses[file];

      if (!results) {
        return 'Unknown';
      }

      return results.status;
    }
  }, {
    key: "assertionsForTestFile",
    value: function assertionsForTestFile(file) {
      var results = this.fileStatuses[file];
      return results ? results.assertions : null;
    }
  }, {
    key: "stateForTestAssertion",
    value: function stateForTestAssertion(file, name) {
      var results = this.fileStatuses[file];

      if (!results || !results.assertions) {
        return null;
      }

      var assertion = results.assertions.find(function (a) {
        return a.title === name;
      });

      if (!assertion) {
        return null;
      }

      return assertion;
    }
  }]);

  return TestReconciler;
}();

exports["default"] = TestReconciler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90ZXN0X3JlY29uY2lsZXIuanMiXSwibmFtZXMiOlsiVGVzdFJlY29uY2lsZXIiLCJmaWxlU3RhdHVzZXMiLCJyZXN1bHRzIiwic3RhdHVzTGlzdCIsInRlc3RSZXN1bHRzIiwiZm9yRWFjaCIsImZpbGUiLCJzdGF0dXMiLCJzdGF0dXNUb1JlY29uY2lsYXRpb25TdGF0ZSIsImZpbGVTdGF0dXMiLCJhc3NlcnRpb25zIiwibWFwQXNzZXJ0aW9ucyIsIm5hbWUiLCJhc3NlcnRpb25SZXN1bHRzIiwibWVzc2FnZSIsInB1c2giLCJmaWxlTmFtZSIsImZpbGVuYW1lIiwiY29udmVydEplc3RMb2NhdGlvbiIsImplc3RMb2NhdGlvbiIsImxpbmUiLCJtYXAiLCJhc3NlcnRpb24iLCJmYWlsdXJlTWVzc2FnZXMiLCJzaG9ydCIsInRlcnNlIiwibG9jYXRpb24iLCJzcGxpdCIsInRyaW0iLCJzYW5pdGl6ZVNob3J0RXJyb3JNZXNzYWdlIiwibGluZU9mRXJyb3IiLCJzaG9ydE1lc3NhZ2UiLCJ0ZXJzZU1lc3NhZ2UiLCJ0aXRsZSIsImZ1bGxOYW1lIiwiYW5jZXN0b3JUaXRsZXMiLCJzdHJpbmciLCJpbmNsdWRlcyIsInNwbGljZSIsImpvaW4iLCJyZXBsYWNlIiwiZmlsZVBhdGgiLCJwYXRoIiwiYmFzZW5hbWUiLCJyZXN0T2ZUcmFjZSIsInBhcnNlSW50IiwiZmluZCIsImEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFVQTs7Ozs7Ozs7OztBQUtBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0lBQ3FCQSxjO0FBR25CLDRCQUFjO0FBQUE7O0FBQ1osU0FBS0MsWUFBTCxHQUFvQixFQUFwQjtBQUNELEcsQ0FFRDtBQUNBO0FBQ0E7QUFDQTs7Ozs7V0FDQSxrQ0FBeUJDLE9BQXpCLEVBQW1GO0FBQUE7O0FBQ2pGO0FBQ0EsVUFBTUMsVUFBcUMsR0FBRyxFQUE5QztBQUNBRCxNQUFBQSxPQUFP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akIsRUFBd0Q7QUFDdEQsVUFBTUosT0FBTyxHQUFHLEtBQUtELFlBQUwsQ0FBa0JLLElBQWxCLENBQWhCOztBQUNBLFVBQUksQ0FBQ0osT0FBTCxFQUFjO0FBQ1osZUFBTyxTQUFQO0FBQ0Q7O0FBQ0QsYUFBT0EsT0FBTyxDQUFDSyxNQUFmO0FBQ0Q7OztXQUVELCtCQUFzQkQsSUFBdEIsRUFBa0U7QUFDaEUsVUFBTUosT0FBTyxHQUFHLEtBQUtELFlBQUwsQ0FBa0JLLElBQWxCLENBQWhCO0FBQ0EsYUFBT0osT0FBTyxHQUFHQSxPQUFPLENBQUNRLFVBQVgsR0FBd0IsSUFBdEM7QUFDRDs7O1dBRUQsK0JBQXNCSixJQUF0QixFQUFvQ00sSUFBcEMsRUFBOEU7QUFDNUUsVUFBTVYsT0FBTyxHQUFHLEtBQUtELFlBQUwsQ0FBa0JLLElBQWxCLENBQWhCOztBQUNBLFVBQUksQ0FBQ0osT0FBRCxJQUFZLENBQUNBLE9BQU8sQ0FBQ1EsVUFBekIsRUFBcUM7QUFDbkMsZUFBTyxJQUFQO0FBQ0Q7O0FBQ0QsVUFBTVksU0FBUyxHQUFHcEIsT0FBTyxDQUFDUSxVQUFSLENBQW1Cb0MsSUFBbkIsQ0FBd0IsVUFBQ0MsQ0FBRDtBQUFBLGVBQU9BLENBQUMsQ0FBQ2QsS0FBRixLQUFZckIsSUFBbkI7QUFBQSxPQUF4QixDQUFsQjs7QUFDQSxVQUFJLENBQUNVLFNBQUwsRUFBZ0I7QUFDZCxlQUFPLElBQVA7QUFDRDs7QUFDRCxhQUFPQSxTQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBjbGFzcy1tZXRob2RzLXVzZS10aGlzICovXG4vKipcbiAqIENvcHlyaWdodCAoYykgMjAxNC1wcmVzZW50LCBGYWNlYm9vaywgSW5jLiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKi9cblxuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdHlwZSB7VGVzdEZpbGVBc3NlcnRpb25TdGF0dXMsIFRlc3RBc3NlcnRpb25TdGF0dXMsIFRlc3RSZWNvbmNpbGlhdGlvblN0YXRlLCBMb2NhdGlvbn0gZnJvbSAnLi90eXBlcyc7XG5cbmltcG9ydCB0eXBlIHtGb3JtYXR0ZWRBc3NlcnRpb25SZXN1bHQsIEZvcm1hdHRlZFRlc3RSZXN1bHRzfSBmcm9tICcuLi90eXBlcy9UZXN0UmVzdWx0JztcblxuLyoqXG4gKiAgWW91IGhhdmUgYSBKZXN0IHRlc3QgcnVubmVyIHdhdGNoaW5nIGZvciBjaGFuZ2VzLCBhbmQgeW91IGhhdmVcbiAqICBhbiBleHRlbnNpb24gdGhhdCB3YW50cyB0byBrbm93IHdoZXJlIHRvIHNob3cgZXJyb3JzIGFmdGVyIGZpbGUgcGFyc2luZy5cbiAqXG4gKiAgVGhpcyBjbGFzcyByZXByZXNlbnRzIHRoZSBzdGF0ZSBiZXR3ZWVuIHJ1bnMsIGtlZXBpbmcgdHJhY2sgb2YgcGFzc2VzL2ZhaWxzXG4gKiAgYXQgYSBmaWxlIGxldmVsLCBnZW5lcmF0aW5nIHVzZWZ1bCBlcnJvciBtZXNzYWdlcyBhbmQgcHJvdmlkaW5nIGEgbmljZSBBUEkuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRlc3RSZWNvbmNpbGVyIHtcbiAgZmlsZVN0YXR1c2VzOiB7W2tleTogc3RyaW5nXTogVGVzdEZpbGVBc3NlcnRpb25TdGF0dXN9O1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuZmlsZVN0YXR1c2VzID0ge307XG4gIH1cblxuICAvLyB0aGUgcHJvY2Vzc2VkIHRlc3QgcmVzdWx0cyB3aWxsIGJlIHJldHVybmVkIGltbWVkaWF0ZWx5IGluc3RlYWQgb2Ygc2F2ZWQgaW5cbiAgLy8gaW5zdGFuY2UgcHJvcGVydGllcy4gVGhpcyBpcyAxKSB0byBwcmV2ZW50IHJhY2UgY29uZGl0aW9uIDIpIHRoZSBkYXRhIGlzIGFscmVhZHlcbiAgLy8gc3RvcmVkIGluIHRoZSB0aGlzLmZpbGVTdGF0dXNlcywgbm8gZHVwIGlzIGJldHRlciAzKSBjbGllbnQgd2lsbCBtb3N0IGxpa2VseSBuZWVkIHRvIHByb2Nlc3NcbiAgLy8gYWxsIHRoZSByZXN1bHRzIGFueXdheS5cbiAgdXBkYXRlRmlsZVdpdGhKZXN0U3RhdHVzKHJlc3VsdHM6IEZvcm1hdHRlZFRlc3RSZXN1bHRzKTogVGVzdEZpbGVBc3NlcnRpb25TdGF0dXNbXSB7XG4gICAgLy8gTG9vcCB0aHJvdWdoIGFsbCBmaWxlcyBpbnNpZGUgdGhlIHJlcG9ydCBmcm9tIEplc3RcbiAgICBjb25zdCBzdGF0dXNMaXN0OiBUZXN0RmlsZUFzc2VydGlvblN0YXR1c1tdID0gW107XG4gICAgcmVzdWx0cy50ZXN0UmVzdWx0cy5mb3JFYWNoKChmaWxlKSA9PiB7XG4gICAgICAvLyBEaWQgdGhlIGZpbGUgcGFzcy9mYWlsP1xuICAgICAgY29uc3Qgc3RhdHVzID0gdGhpcy5zdGF0dXNUb1JlY29uY2lsYXRpb25TdGF0ZShmaWxlLnN0YXR1cyk7XG4gICAgICAvLyBDcmVhdGUgb3VyIG93biBzaW1wbGVyIHJlcHJlc2VudGF0aW9uXG4gICAgICBjb25zdCBmaWxlU3RhdHVzOiBUZXN0RmlsZUFzc2VydGlvblN0YXR1cyA9IHtcbiAgICAgICAgYXNzZXJ0aW9uczogdGhpcy5tYXBBc3NlcnRpb25zKGZpbGUubmFtZSwgZmlsZS5hc3NlcnRpb25SZXN1bHRzKSxcbiAgICAgICAgZmlsZTogZmlsZS5uYW1lLFxuICAgICAgICBtZXNzYWdlOiBmaWxlLm1lc3NhZ2UsXG4gICAgICAgIHN0YXR1cyxcbiAgICAgIH07XG4gICAgICB0aGlzLmZpbGVTdGF0dXNlc1tmaWxlLm5hbWVdID0gZmlsZVN0YXR1cztcbiAgICAgIHN0YXR1c0xpc3QucHVzaChmaWxlU3RhdHVzKTtcbiAgICB9KTtcbiAgICByZXR1cm4gc3RhdHVzTGlzdDtcbiAgfVxuXG4gIC8qKlxuICAgKiByZW1vdmUgamVzdCBzdGF0dXMgb2YgdGhlIHRlc3QgZmlsZSBmcm9tIHRoZSBjYWNoZWQgcmVzdWx0c1xuICAgKiBAcGFyYW0ge3N0cmluZ30gZmlsZU5hbWVcbiAgICovXG4gIHJlbW92ZVRlc3RGaWxlKGZpbGVOYW1lOiBzdHJpbmcpIHtcbiAgICBkZWxldGUgdGhpcy5maWxlU3RhdHVzZXNbZmlsZU5hbWVdO1xuICB9XG5cbiAgLy8gQSBmYWlsZWQgdGVzdCBhbHNvIGNvbnRhaW5zIHRoZSBzdGFjayB0cmFjZSBmb3IgYW4gYGV4cGVjdGBcbiAgLy8gd2UgZG9uJ3QgZ2V0IHRoaXMgYXMgc3RydWN0dXJlZCBkYXRhLCBidXQgd2hhdCB3ZSBnZXRcbiAgLy8gaXMgdXNlZnVsIGVub3VnaCB0byBtYWtlIGl0IGZvciBvdXJzZWx2ZXNcblxuICBtYXBBc3NlcnRpb25zKGZpbGVuYW1lOiBzdHJpbmcsIGFzc2VydGlvbnM6IEFycmF5PEZvcm1hdHRlZEFzc2VydGlvblJlc3VsdD4pOiBBcnJheTxUZXN0QXNzZXJ0aW9uU3RhdHVzPiB7XG4gICAgLy8gY29udmVydCBqZXN0IGxvY2F0aW9uIChjb2x1bW4gaXMgMC1iYXNlZCBhbmQgbGluZSBpcyAxLWJhc2VkKSB0byBhbGwgMC1iYXNlZCBsb2NhdGlvbiB1c2VkIGludGVybmFsbHkgaW4gdGhpcyBwYWNrYWdlXG4gICAgLyogZXNsaW50LWRpc2FibGUgbm8tcGFyYW0tcmVhc3NpZ24gKi9cbiAgICBjb25zdCBjb252ZXJ0SmVzdExvY2F0aW9uID0gKGplc3RMb2NhdGlvbjogP0xvY2F0aW9uKSA9PiB7XG4gICAgICBpZiAoamVzdExvY2F0aW9uKSB7XG4gICAgICAgIGplc3RMb2NhdGlvbi5saW5lIC09IDE7XG4gICAgICB9XG4gICAgICByZXR1cm4gamVzdExvY2F0aW9uO1xuICAgIH07XG4gICAgLy8gSXMgaXQgamVzdCA8IDE3PyBlLmcuIEJlZm9yZSBJIGFkZGVkIHRoaXMgdG8gdGhlIEpTT05cbiAgICBpZiAoIWFzc2VydGlvbnMpIHtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG5cbiAgICAvLyBDaGFuZ2UgYWxsIGZhaWxpbmcgYXNzZXJ0aW9ucyBpbnRvIHN0cnVjdHVyZWQgZGF0YVxuICAgIHJldHVybiBhc3NlcnRpb25zLm1hcCgoYXNzZXJ0aW9uKSA9PiB7XG4gICAgICAvLyBGYWlsdXJlIG1lc3NhZ2VzIHNlZW1zIHRvIGFsd2F5cyBiZSBhbiBhcnJheSBvZiBvbmUgaXRlbVxuICAgICAgY29uc3QgbWVzc2FnZSA9IGFzc2VydGlvbi5mYWlsdXJlTWVzc2FnZXMgJiYgYXNzZXJ0aW9uLmZhaWx1cmVNZXNzYWdlc1swXTtcbiAgICAgIGxldCBzaG9ydCA9IG51bGw7XG4gICAgICBsZXQgdGVyc2UgPSBudWxsO1xuICAgICAgbGV0IGxpbmUgPSBudWxsO1xuICAgICAgY29uc3QgbG9jYXRpb24gPSBjb252ZXJ0SmVzdExvY2F0aW9uKGFzc2VydGlvbi5sb2NhdGlvbik7IC8vIG91dHB1dCBmcm9tIGplc3QgLS10ZXN0TG9jYXRpb25JblJlc3VsdHMgKGh0dHBzOi8vamVzdGpzLmlvL2RvY3MvZW4vY2xpI3Rlc3Rsb2NhdGlvbmlucmVzdWx0cylcbiAgICAgIGlmIChtZXNzYWdlKSB7XG4gICAgICAgIC8vIEp1c3QgdGhlIGZpcnN0IGxpbmUsIHdpdGggbGl0dGxlIHdoaXRlc3BhY2VcbiAgICAgICAgc2hvcnQgPSBtZXNzYWdlLnNwbGl0KCcgICBhdCcsIDEpWzBdLnRyaW0oKTtcbiAgICAgICAgLy8gdGhpcyB3aWxsIHNob3cgaW5saW5lLCBzbyB3ZSB3YW50IHRvIHNob3cgdmVyeSBsaXR0bGVcbiAgICAgICAgdGVyc2UgPSB0aGlzLnNhbml0aXplU2hvcnRFcnJvck1lc3NhZ2Uoc2hvcnQpO1xuICAgICAgICBsaW5lID0gdGhpcy5saW5lT2ZFcnJvcihtZXNzYWdlLCBmaWxlbmFtZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4ge1xuICAgICAgICBsaW5lLFxuICAgICAgICBtZXNzYWdlOiBtZXNzYWdlIHx8ICcnLFxuICAgICAgICBzaG9ydE1lc3NhZ2U6IHNob3J0LFxuICAgICAgICBzdGF0dXM6IHRoaXMuc3RhdHVzVG9SZWNvbmNpbGF0aW9uU3RhdGUoYXNzZXJ0aW9uLnN0YXR1cyksXG4gICAgICAgIHRlcnNlTWVzc2FnZTogdGVyc2UsXG4gICAgICAgIHRpdGxlOiBhc3NlcnRpb24udGl0bGUsXG4gICAgICAgIGxvY2F0aW9uLFxuICAgICAgICBmdWxsTmFtZTogYXNzZXJ0aW9uLmZ1bGxOYW1lLFxuICAgICAgICBhbmNlc3RvclRpdGxlczogYXNzZXJ0aW9uLmFuY2VzdG9yVGl0bGVzLFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8vIERvIGV2ZXJ5dGhpbmcgd2UgY2FuIHRvIHRyeSBtYWtlIGEgb25lLWxpbmVyIGZyb20gdGhlIGVycm9yIHJlcG9ydFxuICBzYW5pdGl6ZVNob3J0RXJyb3JNZXNzYWdlKHN0cmluZzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAoc3RyaW5nLmluY2x1ZGVzKCdkb2VzIG5vdCBtYXRjaCBzdG9yZWQgc25hcHNob3QnKSkge1xuICAgICAgcmV0dXJuICdTbmFwc2hvdCBoYXMgY2hhbmdlZCc7XG4gICAgfVxuXG4gICAgaWYgKHN0cmluZy5pbmNsdWRlcygnTmV3IHNuYXBzaG90IHdhcyBub3Qgd3JpdHRlbicpKSB7XG4gICAgICByZXR1cm4gJ05ldyBzbmFwc2hvdCBpcyByZWFkeSB0byB3cml0ZSc7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0cmluZ1xuICAgICAgLnNwbGl0KCdcXG4nKVxuICAgICAgLnNwbGljZSgyKVxuICAgICAgLmpvaW4oJycpXG4gICAgICAucmVwbGFjZSgvXFxzXFxzKy9nLCAnICcpXG4gICAgICAucmVwbGFjZSgnUmVjZWl2ZWQ6JywgJywgUmVjZWl2ZWQ6JylcbiAgICAgIC5zcGxpdCgnRGlmZmVyZW5jZTonKVswXTtcbiAgfVxuXG4gIC8vIFB1bGwgdGhlIGxpbmUgb3V0IGZyb20gdGhlIHN0YWNrIHRyYWNlXG4gIGxpbmVPZkVycm9yKG1lc3NhZ2U6IHN0cmluZywgZmlsZVBhdGg6IHN0cmluZyk6ID9udW1iZXIge1xuICAgIGNvbnN0IGZpbGVuYW1lID0gcGF0aC5iYXNlbmFtZShmaWxlUGF0aCk7XG4gICAgY29uc3QgcmVzdE9mVHJhY2UgPSBtZXNzYWdlLnNwbGl0KGZpbGVuYW1lLCAyKVsxXTtcbiAgICByZXR1cm4gcmVzdE9mVHJhY2UgPyBwYXJzZUludChyZXN0T2ZUcmFjZS5zcGxpdCgnOicpWzFdLCAxMCkgOiBudWxsO1xuICB9XG5cbiAgc3RhdHVzVG9SZWNvbmNpbGF0aW9uU3RhdGUoc3RhdHVzOiBzdHJpbmcpOiBUZXN0UmVjb25jaWxpYXRpb25TdGF0ZSB7XG4gICAgc3dpdGNoIChzdGF0dXMpIHtcbiAgICAgIGNhc2UgJ3Bhc3NlZCc6XG4gICAgICAgIHJldHVybiAnS25vd25TdWNjZXNzJztcbiAgICAgIGNhc2UgJ2ZhaWxlZCc6XG4gICAgICAgIHJldHVybiAnS25vd25GYWlsJztcbiAgICAgIGNhc2UgJ3BlbmRpbmcnOlxuICAgICAgICByZXR1cm4gJ0tub3duU2tpcCc7XG4gICAgICBjYXNlICd0b2RvJzpcbiAgICAgICAgcmV0dXJuICdLbm93blRvZG8nO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuICdVbmtub3duJztcbiAgICB9XG4gIH1cblxuICBzdGF0ZUZvclRlc3RGaWxlKGZpbGU6IHN0cmluZyk6IFRlc3RSZWNvbmNpbGlhdGlvblN0YXRlIHtcbiAgICBjb25zdCByZXN1bHRzID0gdGhpcy5maWxlU3RhdHVzZXNbZmlsZV07XG4gICAgaWYgKCFyZXN1bHRzKSB7XG4gICAgICByZXR1cm4gJ1Vua25vd24nO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0cy5zdGF0dXM7XG4gIH1cblxuICBhc3NlcnRpb25zRm9yVGVzdEZpbGUoZmlsZTogc3RyaW5nKTogVGVzdEFzc2VydGlvblN0YXR1c1tdIHwgbnVsbCB7XG4gICAgY29uc3QgcmVzdWx0cyA9IHRoaXMuZmlsZVN0YXR1c2VzW2ZpbGVdO1xuICAgIHJldHVybiByZXN1bHRzID8gcmVzdWx0cy5hc3NlcnRpb25zIDogbnVsbDtcbiAgfVxuXG4gIHN0YXRlRm9yVGVzdEFzc2VydGlvbihmaWxlOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IFRlc3RBc3NlcnRpb25TdGF0dXMgfCBudWxsIHtcbiAgICBjb25zdCByZXN1bHRzID0gdGhpcy5maWxlU3RhdHVzZXNbZmlsZV07XG4gICAgaWYgKCFyZXN1bHRzIHx8ICFyZXN1bHRzLmFzc2VydGlvbnMpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBjb25zdCBhc3NlcnRpb24gPSByZXN1bHRzLmFzc2VydGlvbnMuZmluZCgoYSkgPT4gYS50aXRsZSA9PT0gbmFtZSk7XG4gICAgaWYgKCFhc3NlcnRpb24pIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gYXNzZXJ0aW9uO1xuICB9XG59XG4iXX0=