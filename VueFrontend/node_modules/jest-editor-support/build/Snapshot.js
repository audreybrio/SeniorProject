"use strict";

require("core-js/modules/es.object.define-property.js");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = void 0;

require("regenerator-runtime/runtime.js");

require("core-js/modules/es.object.assign.js");

require("core-js/modules/es.object.create.js");

require("core-js/modules/es.function.name.js");

require("core-js/modules/es.array.join.js");

require("core-js/modules/es.array.map.js");

require("core-js/modules/es.array.concat.js");

require("core-js/modules/es.object.to-string.js");

require("core-js/modules/es.promise.js");

require("core-js/modules/es.array.index-of.js");

require("core-js/modules/es.array.filter.js");

var _traverse = _interopRequireDefault(require("@babel/traverse"));

var _jestSnapshot = require("jest-snapshot");

var _babel_parser = require("./parsers/babel_parser");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

var describeVariants = Object.assign(Object.create(null), {
  describe: true,
  fdescribe: true,
  xdescribe: true
});
var base = Object.assign(Object.create(null), {
  describe: true,
  it: true,
  test: true
});
var decorators = Object.assign(Object.create(null), {
  only: true,
  skip: true
});
var validParents = Object.assign(Object.create(null), base, describeVariants, Object.assign(Object.create(null), {
  fit: true,
  xit: true,
  xtest: true
}));

var isValidMemberExpression = function isValidMemberExpression(node) {
  return node.object && base[node.object.name] && node.property && decorators[node.property.name];
};

var isDescribe = function isDescribe(node) {
  return describeVariants[node.name] || isValidMemberExpression(node) && node.object.name === 'describe';
};

var isValidParent = function isValidParent(parent) {
  return parent.callee && (validParents[parent.callee.name] || isValidMemberExpression(parent.callee));
};

var getArrayOfParents = function getArrayOfParents(path) {
  var result = [];
  var parent = path.parentPath;

  while (parent) {
    result.unshift(parent.node);
    parent = parent.parentPath;
  }

  return result;
};

var buildName = function buildName(snapshotNode, parents, position) {
  var fullName = parents.map(function (parent) {
    return parent.arguments[0].value;
  }).join(' ');
  return _jestSnapshot.utils.testNameToKey(fullName, position);
};

var Snapshot = /*#__PURE__*/function () {
  function Snapshot(parser, customMatchers, projectConfig) {
    var _this = this;

    _classCallCheck(this, Snapshot);

    this._parser = parser || _babel_parser.getASTfor;
    this._matchers = ['toMatchSnapshot', 'toThrowErrorMatchingSnapshot'].concat(customMatchers || []);
    this._projectConfig = projectConfig;
    this._resolverPromise = (0, _jestSnapshot.buildSnapshotResolver)(this._projectConfig || {}, function () {
      return Promise.resolve();
    }).then(function (resolver) {
      _this.snapshotResolver = resolver;
    });
  }

  _createClass(Snapshot, [{
    key: "getMetadataAsync",
    value: function () {
      var _getMetadataAsync = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee(filePath) {
        var verbose,
            _args = arguments;
        return regeneratorRuntime.wrap(function _callee$(_context) {
          while (1) {
            switch (_context.prev = _context.next) {
              case 0:
                verbose = _args.length > 1 && _args[1] !== undefined ? _args[1] : false;

                if (this.snapshotResolver) {
                  _context.next = 4;
                  break;
                }

                _context.next = 4;
                return this._resolverPromise;

              case 4:
                return _context.abrupt("return", this.getMetadata(filePath, verbose));

              case 5:
              case "end":
                return _context.stop();
            }
          }
        }, _callee, this);
      }));

      function getMetadataAsync(_x) {
        return _getMetadataAsync.apply(this, arguments);
      }

      return getMetadataAsync;
    }()
  }, {
    key: "getMetadata",
    value: function getMetadata(filePath) {
      var _this2 = this;

      var verbose = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;

      if (!this.snapshotResolver) {
        throw new Error('snapshotResolver is not ready yet, consider migrating to "getMetadataAsync" instead');
      }

      var snapshotPath = this.snapshotResolver.resolveSnapshotPath(filePath);
      var fileNode;

      try {
        fileNode = this._parser(filePath);
      } catch (error) {
        if (verbose) {
          // eslint-disable-next-line no-console
          console.warn(error);
        }

        return [];
      }

      var state = {
        found: []
      };
      var Visitors = {
        Identifier: function Identifier(path, _state, matchers) {
          if (matchers.indexOf(path.node.name) >= 0) {
            _state.found.push({
              node: path.node,
              parents: getArrayOfParents(path)
            });
          }
        }
      };
      (0, _traverse["default"])(fileNode, {
        enter: function enter(path) {
          var visitor = Visitors[path.node.type];

          if (visitor != null) {
            visitor(path, state, _this2._matchers);
          }
        }
      }); // NOTE if no projectConfig is given the default resolver will be used

      var snapshots = _jestSnapshot.utils.getSnapshotData(snapshotPath, 'none').data;

      var lastParent = null;
      var count = 1;
      return state.found.map(function (snapshotNode) {
        var parents = snapshotNode.parents.filter(isValidParent);
        var innerAssertion = parents[parents.length - 1];

        if (lastParent !== innerAssertion) {
          lastParent = innerAssertion;
          count = 1;
        }

        var result = {
          content: undefined,
          count: count,
          exists: false,
          name: '',
          node: snapshotNode.node
        };
        count += 1;

        if (!innerAssertion || isDescribe(innerAssertion.callee)) {
          // An expectation inside describe never gets executed.
          return result;
        }

        result.name = buildName(snapshotNode, parents, result.count);

        if (snapshots[result.name]) {
          result.exists = true;
          result.content = snapshots[result.name];
        }

        return result;
      });
    }
  }]);

  return Snapshot;
}();

exports["default"] = Snapshot;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TbmFwc2hvdC5qcyJdLCJuYW1lcyI6WyJkZXNjcmliZVZhcmlhbnRzIiwiT2JqZWN0IiwiYXNzaWduIiwiY3JlYXRlIiwiZGVzY3JpYmUiLCJmZGVzY3JpYmUiLCJ4ZGVzY3JpYmUiLCJiYXNlIiwiaXQiLCJ0ZXN0IiwiZGVjb3JhdG9ycyIsIm9ubHkiLCJza2lwIiwidmFsaWRQYXJlbnRzIiwiZml0IiwieGl0IiwieHRlc3QiLCJpc1ZhbGlkTWVtYmVyRXhwcmVzc2lvbiIsIm5vZGUiLCJvYmplY3QiLCJuYW1lIiwicHJvcGVydHkiLCJpc0Rlc2NyaWJlIiwiaXNWYWxpZFBhcmVudCIsInBhcmVudCIsImNhbGxlZSIsImdldEFycmF5T2ZQYXJlbnRzIiwicGF0aCIsInJlc3VsdCIsInBhcmVudFBhdGgiLCJ1bnNoaWZ0IiwiYnVpbGROYW1lIiwic25hcHNob3ROb2RlIiwicGFyZW50cyIsInBvc2l0aW9uIiwiZnVsbE5hbWUiLCJtYXAiLCJhcmd1bWVudHMiLCJ2YWx1ZSIsImpvaW4iLCJ1dGlscyIsInRlc3ROYW1lVG9LZXkiLCJTbmFwc2hvdCIsInBhcnNlciIsImN1c3RvbU1hdGNoZXJzIiwicHJvamVjdENvbmZpZyIsIl9wYXJzZXIiLCJnZXRBU1Rmb3IiLCJfbWF0Y2hlcnMiLCJjb25jYXQiLCJfcHJvamVjdENvbmZpZyIsIl9yZXNvbHZlclByb21pc2UiLCJQcm9taXNlIiwicmVzb2x2ZSIsInRoZW4iLCJyZXNvbHZlciIsInNuYXBzaG90UmVzb2x2ZXIiLCJmaWxlUGF0aCIsInZlcmJvc2UiLCJnZXRNZXRhZGF0YSIsIkVycm9yIiwic25hcHNob3RQYXRoIiwicmVzb2x2ZVNuYXBzaG90UGF0aCIsImZpbGVOb2RlIiwiZXJyb3IiLCJjb25zb2xlIiwid2FybiIsInN0YXRlIiwiZm91bmQiLCJWaXNpdG9ycyIsIklkZW50aWZpZXIiLCJfc3RhdGUiLCJtYXRjaGVycyIsImluZGV4T2YiLCJwdXNoIiwiZW50ZXIiLCJ2aXNpdG9yIiwidHlwZSIsInNuYXBzaG90cyIsImdldFNuYXBzaG90RGF0YSIsImRhdGEiLCJsYXN0UGFyZW50IiwiY291bnQiLCJmaWx0ZXIiLCJpbm5lckFzc2VydGlvbiIsImxlbmd0aCIsImNvbnRlbnQiLCJ1bmRlZmluZWQiLCJleGlzdHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFVQTs7QUFDQTs7QUFHQTs7Ozs7Ozs7Ozs7Ozs7QUFXQSxJQUFNQSxnQkFBZ0IsR0FBR0MsTUFBTSxDQUFDQyxNQUFQLENBQWVELE1BQU0sQ0FBQ0UsTUFBUCxDQUFjLElBQWQsQ0FBZixFQUEyRTtBQUNsR0MsRUFBQUEsUUFBUSxFQUFFLElBRHdGO0FBRWxHQyxFQUFBQSxTQUFTLEVBQUUsSUFGdUY7QUFHbEdDLEVBQUFBLFNBQVMsRUFBRTtBQUh1RixDQUEzRSxDQUF6QjtBQUtBLElBQU1DLElBQUksR0FBR04sTUFBTSxDQUFDQyxNQUFQLENBQWVELE1BQU0sQ0FBQ0UsTUFBUCxDQUFjLElBQWQsQ0FBZixFQUEyRTtBQUN0RkMsRUFBQUEsUUFBUSxFQUFFLElBRDRFO0FBRXRGSSxFQUFBQSxFQUFFLEVBQUUsSUFGa0Y7QUFHdEZDLEVBQUFBLElBQUksRUFBRTtBQUhnRixDQUEzRSxDQUFiO0FBS0EsSUFBTUMsVUFBVSxHQUFHVCxNQUFNLENBQUNDLE1BQVAsQ0FBZUQsTUFBTSxDQUFDRSxNQUFQLENBQWMsSUFBZCxDQUFmLEVBQTJFO0FBQzVGUSxFQUFBQSxJQUFJLEVBQUUsSUFEc0Y7QUFFNUZDLEVBQUFBLElBQUksRUFBRTtBQUZzRixDQUEzRSxDQUFuQjtBQUtBLElBQU1DLFlBQVksR0FBR1osTUFBTSxDQUFDQyxNQUFQLENBQ2xCRCxNQUFNLENBQUNFLE1BQVAsQ0FBYyxJQUFkLENBRGtCLEVBRW5CSSxJQUZtQixFQUduQlAsZ0JBSG1CLEVBSW5CQyxNQUFNLENBQUNDLE1BQVAsQ0FBZUQsTUFBTSxDQUFDRSxNQUFQLENBQWMsSUFBZCxDQUFmLEVBQTJFO0FBQ3pFVyxFQUFBQSxH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QUFJLENBQVQ7O0FBRUEsWUFBSSxDQUFDRSxjQUFELElBQW1COUQsVUFBVSxDQUFDOEQsY0FBYyxDQUFDM0QsTUFBaEIsQ0FBakMsRUFBMEQ7QUFDeEQ7QUFDQSxpQkFBT0csTUFBUDtBQUNEOztBQUVEQSxRQUFBQSxNQUFNLENBQUNSLElBQVAsR0FBY1csU0FBUyxDQUFDQyxZQUFELEVBQWVDLE9BQWYsRUFBd0JMLE1BQU0sQ0FBQ3NELEtBQS9CLENBQXZCOztBQUVBLFlBQUlKLFNBQVMsQ0FBQ2xELE1BQU0sQ0FBQ1IsSUFBUixDQUFiLEVBQTRCO0FBQzFCUSxVQUFBQSxNQUFNLENBQUM0RCxNQUFQLEdBQWdCLElBQWhCO0FBQ0E1RCxVQUFBQSxNQUFNLENBQUMwRCxPQUFQLEdBQWlCUixTQUFTLENBQUNsRCxNQUFNLENBQUNSLElBQVIsQ0FBMUI7QUFDRDs7QUFDRCxlQUFPUSxNQUFQO0FBQ0QsT0E5Qk0sQ0FBUDtBQStCRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSAyMDE0LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgQlNELXN0eWxlIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuIEFuIGFkZGl0aW9uYWwgZ3JhbnRcbiAqIG9mIHBhdGVudCByaWdodHMgY2FuIGJlIGZvdW5kIGluIHRoZSBQQVRFTlRTIGZpbGUgaW4gdGhlIHNhbWUgZGlyZWN0b3J5LlxuICpcbiAqIEBmbG93XG4gKi9cblxuaW1wb3J0IHRyYXZlcnNlIGZyb20gJ0BiYWJlbC90cmF2ZXJzZSc7XG5pbXBvcnQge2J1aWxkU25hcHNob3RSZXNvbHZlciwgU25hcHNob3RSZXNvbHZlciwgdXRpbHN9IGZyb20gJ2plc3Qtc25hcHNob3QnO1xuaW1wb3J0IHR5cGUge1Byb2plY3RDb25maWd9IGZyb20gJy4uL3R5cGVzL0NvbmZpZyc7XG5cbmltcG9ydCB7Z2V0QVNUZm9yfSBmcm9tICcuL3BhcnNlcnMvYmFiZWxfcGFyc2VyJztcblxudHlwZSBOb2RlID0gYW55O1xuXG50eXBlIFNuYXBzaG90TWV0YWRhdGEgPSB7XG4gIGV4aXN0czogdHJ1ZSB8IGZhbHNlLFxuICBuYW1lOiBzdHJpbmcsXG4gIG5vZGU6IE5vZGUsXG4gIGNvbnRlbnQ/OiBzdHJpbmcsXG59O1xuXG5jb25zdCBkZXNjcmliZVZhcmlhbnRzID0gT2JqZWN0LmFzc2lnbigoT2JqZWN0LmNyZWF0ZShudWxsKToge1tzdHJpbmddOiBib29sZWFuLCBfX3Byb3RvX186IG51bGx9KSwge1xuICBkZXNjcmliZTogdHJ1ZSxcbiAgZmRlc2NyaWJlOiB0cnVlLFxuICB4ZGVzY3JpYmU6IHRydWUsXG59KTtcbmNvbnN0IGJhc2UgPSBPYmplY3QuYXNzaWduKChPYmplY3QuY3JlYXRlKG51bGwpOiB7W3N0cmluZ106IGJvb2xlYW4sIF9fcHJvdG9fXzogbnVsbH0pLCB7XG4gIGRlc2NyaWJlOiB0cnVlLFxuICBpdDogdHJ1ZSxcbiAgdGVzdDogdHJ1ZSxcbn0pO1xuY29uc3QgZGVjb3JhdG9ycyA9IE9iamVjdC5hc3NpZ24oKE9iamVjdC5jcmVhdGUobnVsbCk6IHtbc3RyaW5nXTogYm9vbGVhbiwgX19wcm90b19fOiBudWxsfSksIHtcbiAgb25seTogdHJ1ZSxcbiAgc2tpcDogdHJ1ZSxcbn0pO1xuXG5jb25zdCB2YWxpZFBhcmVudHMgPSBPYmplY3QuYXNzaWduKFxuICAoT2JqZWN0LmNyZWF0ZShudWxsKTogYW55KSxcbiAgYmFzZSxcbiAgZGVzY3JpYmVWYXJpYW50cyxcbiAgT2JqZWN0LmFzc2lnbigoT2JqZWN0LmNyZWF0ZShudWxsKToge1tzdHJpbmddOiBib29sZWFuLCBfX3Byb3RvX186IG51bGx9KSwge1xuICAgIGZpdDogdHJ1ZSxcbiAgICB4aXQ6IHRydWUsXG4gICAgeHRlc3Q6IHRydWUsXG4gIH0pXG4pO1xuXG5jb25zdCBpc1ZhbGlkTWVtYmVyRXhwcmVzc2lvbiA9IChub2RlKSA9PlxuICBub2RlLm9iamVjdCAmJiBiYXNlW25vZGUub2JqZWN0Lm5hbWVdICYmIG5vZGUucHJvcGVydHkgJiYgZGVjb3JhdG9yc1tub2RlLnByb3BlcnR5Lm5hbWVdO1xuXG5jb25zdCBpc0Rlc2NyaWJlID0gKG5vZGUpID0+XG4gIGRlc2NyaWJlVmFyaWFudHNbbm9kZS5uYW1lXSB8fCAoaXNWYWxpZE1lbWJlckV4cHJlc3Npb24obm9kZSkgJiYgbm9kZS5vYmplY3QubmFtZSA9PT0gJ2Rlc2NyaWJlJyk7XG5cbmNvbnN0IGlzVmFsaWRQYXJlbnQgPSAocGFyZW50KSA9PlxuICBwYXJlbnQuY2FsbGVlICYmICh2YWxpZFBhcmVudHNbcGFyZW50LmNhbGxlZS5uYW1lXSB8fCBpc1ZhbGlkTWVtYmVyRXhwcmVzc2lvbihwYXJlbnQuY2FsbGVlKSk7XG5cbmNvbnN0IGdldEFycmF5T2ZQYXJlbnRzID0gKHBhdGgpID0+IHtcbiAgY29uc3QgcmVzdWx0ID0gW107XG4gIGxldCBwYXJlbnQgPSBwYXRoLnBhcmVudFBhdGg7XG4gIHdoaWxlIChwYXJlbnQpIHtcbiAgICByZXN1bHQudW5zaGlmdChwYXJlbnQubm9kZSk7XG4gICAgcGFyZW50ID0gcGFyZW50LnBhcmVudFBhdGg7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbmNvbnN0IGJ1aWxkTmFtZTogKHNuYXBzaG90Tm9kZTogTm9kZSwgcGFyZW50czogQXJyYXk8Tm9kZT4sIHBvc2l0aW9uOiBudW1iZXIpID0+IHN0cmluZyA9IChcbiAgc25hcHNob3ROb2RlLFxuICBwYXJlbnRzLFxuICBwb3NpdGlvblxuKSA9PiB7XG4gIGNvbnN0IGZ1bGxOYW1lID0gcGFyZW50cy5tYXAoKHBhcmVudCkgPT4gcGFyZW50LmFyZ3VtZW50c1swXS52YWx1ZSkuam9pbignICcpO1xuXG4gIHJldHVybiB1dGlscy50ZXN0TmFtZVRvS2V5KGZ1bGxOYW1lLCBwb3NpdGlvbik7XG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTbmFwc2hvdCB7XG4gIF9wYXJzZXI6IEZ1bmN0aW9uO1xuXG4gIF9tYXRjaGVyczogQXJyYXk8c3RyaW5nPjtcblxuICBfcHJvamVjdENvbmZpZzogP1Byb2plY3RDb25maWc7XG5cbiAgc25hcHNob3RSZXNvbHZlcjogP1NuYXBzaG90UmVzb2x2ZXI7XG5cbiAgX3Jlc29sdmVyUHJvbWlzZTogUHJvbWlzZTxTbmFwc2hvdFJlc29sdmVyPjtcblxuICBjb25zdHJ1Y3RvcihwYXJzZXI6IGFueSwgY3VzdG9tTWF0Y2hlcnM/OiBBcnJheTxzdHJpbmc+LCBwcm9qZWN0Q29uZmlnPzogUHJvamVjdENvbmZpZykge1xuICAgIHRoaXMuX3BhcnNlciA9IHBhcnNlciB8fCBnZXRBU1Rmb3I7XG4gICAgdGhpcy5fbWF0Y2hlcnMgPSBbJ3RvTWF0Y2hTbmFwc2hvdCcsICd0b1Rocm93RXJyb3JNYXRjaGluZ1NuYXBzaG90J10uY29uY2F0KGN1c3RvbU1hdGNoZXJzIHx8IFtdKTtcbiAgICB0aGlzLl9wcm9qZWN0Q29uZmlnID0gcHJvamVjdENvbmZpZztcbiAgICB0aGlzLl9yZXNvbHZlclByb21pc2UgPSBidWlsZFNuYXBzaG90UmVzb2x2ZXIodGhpcy5fcHJvamVjdENvbmZpZyB8fCB7fSwgKCkgPT4gUHJvbWlzZS5yZXNvbHZlKCkpLnRoZW4oXG4gICAgICAocmVzb2x2ZXIpID0+IHtcbiAgICAgICAgdGhpcy5zbmFwc2hvdFJlc29sdmVyID0gcmVzb2x2ZXI7XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIGFzeW5jIGdldE1ldGFkYXRhQXN5bmMoZmlsZVBhdGg6IHN0cmluZywgdmVyYm9zZTogYm9vbGVhbiA9IGZhbHNlKTogUHJvbWlzZTxBcnJheTxTbmFwc2hvdE1ldGFkYXRhPj4ge1xuICAgIGlmICghdGhpcy5zbmFwc2hvdFJlc29sdmVyKSB7XG4gICAgICBhd2FpdCB0aGlzLl9yZXNvbHZlclByb21pc2U7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmdldE1ldGFkYXRhKGZpbGVQYXRoLCB2ZXJib3NlKTtcbiAgfVxuXG4gIGdldE1ldGFkYXRhKGZpbGVQYXRoOiBzdHJpbmcsIHZlcmJvc2U6IGJvb2xlYW4gPSBmYWxzZSk6IEFycmF5PFNuYXBzaG90TWV0YWRhdGE+IHtcbiAgICBpZiAoIXRoaXMuc25hcHNob3RSZXNvbHZlcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdzbmFwc2hvdFJlc29sdmVyIGlzIG5vdCByZWFkeSB5ZXQsIGNvbnNpZGVyIG1pZ3JhdGluZyB0byBcImdldE1ldGFkYXRhQXN5bmNcIiBpbnN0ZWFkJyk7XG4gICAgfVxuICAgIGNvbnN0IHNuYXBzaG90UGF0aCA9IHRoaXMuc25hcHNob3RSZXNvbHZlci5yZXNvbHZlU25hcHNob3RQYXRoKGZpbGVQYXRoKTtcblxuICAgIGxldCBmaWxlTm9kZTtcbiAgICB0cnkge1xuICAgICAgZmlsZU5vZGUgPSB0aGlzLl9wYXJzZXIoZmlsZVBhdGgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBpZiAodmVyYm9zZSkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgICBjb25zb2xlLndhcm4oZXJyb3IpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBjb25zdCBzdGF0ZSA9IHtcbiAgICAgIGZvdW5kOiBbXSxcbiAgICB9O1xuICAgIGNvbnN0IFZpc2l0b3JzID0ge1xuICAgICAgSWRlbnRpZmllcihwYXRoLCBfc3RhdGUsIG1hdGNoZXJzKSB7XG4gICAgICAgIGlmIChtYXRjaGVycy5pbmRleE9mKHBhdGgubm9kZS5uYW1lKSA+PSAwKSB7XG4gICAgICAgICAgX3N0YXRlLmZvdW5kLnB1c2goe1xuICAgICAgICAgICAgbm9kZTogcGF0aC5ub2RlLFxuICAgICAgICAgICAgcGFyZW50czogZ2V0QXJyYXlPZlBhcmVudHMocGF0aCksXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgfTtcblxuICAgIHRyYXZlcnNlKGZpbGVOb2RlLCB7XG4gICAgICBlbnRlcjogKHBhdGgpID0+IHtcbiAgICAgICAgY29uc3QgdmlzaXRvciA9IFZpc2l0b3JzW3BhdGgubm9kZS50eXBlXTtcbiAgICAgICAgaWYgKHZpc2l0b3IgIT0gbnVsbCkge1xuICAgICAgICAgIHZpc2l0b3IocGF0aCwgc3RhdGUsIHRoaXMuX21hdGNoZXJzKTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIC8vIE5PVEUgaWYgbm8gcHJvamVjdENvbmZpZyBpcyBnaXZlbiB0aGUgZGVmYXVsdCByZXNvbHZlciB3aWxsIGJlIHVzZWRcblxuICAgIGNvbnN0IHNuYXBzaG90cyA9IHV0aWxzLmdldFNuYXBzaG90RGF0YShzbmFwc2hvdFBhdGgsICdub25lJykuZGF0YTtcbiAgICBsZXQgbGFzdFBhcmVudCA9IG51bGw7XG4gICAgbGV0IGNvdW50ID0gMTtcblxuICAgIHJldHVybiBzdGF0ZS5mb3VuZC5tYXAoKHNuYXBzaG90Tm9kZSkgPT4ge1xuICAgICAgY29uc3QgcGFyZW50cyA9IHNuYXBzaG90Tm9kZS5wYXJlbnRzLmZpbHRlcihpc1ZhbGlkUGFyZW50KTtcbiAgICAgIGNvbnN0IGlubmVyQXNzZXJ0aW9uID0gcGFyZW50c1twYXJlbnRzLmxlbmd0aCAtIDFdO1xuXG4gICAgICBpZiAobGFzdFBhcmVudCAhPT0gaW5uZXJBc3NlcnRpb24pIHtcbiAgICAgICAgbGFzdFBhcmVudCA9IGlubmVyQXNzZXJ0aW9uO1xuICAgICAgICBjb3VudCA9IDE7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IHtcbiAgICAgICAgY29udGVudDogdW5kZWZpbmVkLFxuICAgICAgICBjb3VudCxcbiAgICAgICAgZXhpc3RzOiBmYWxzZSxcbiAgICAgICAgbmFtZTogJycsXG4gICAgICAgIG5vZGU6IHNuYXBzaG90Tm9kZS5ub2RlLFxuICAgICAgfTtcbiAgICAgIGNvdW50ICs9IDE7XG5cbiAgICAgIGlmICghaW5uZXJBc3NlcnRpb24gfHwgaXNEZXNjcmliZShpbm5lckFzc2VydGlvbi5jYWxsZWUpKSB7XG4gICAgICAgIC8vIEFuIGV4cGVjdGF0aW9uIGluc2lkZSBkZXNjcmliZSBuZXZlciBnZXRzIGV4ZWN1dGVkLlxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgfVxuXG4gICAgICByZXN1bHQubmFtZSA9IGJ1aWxkTmFtZShzbmFwc2hvdE5vZGUsIHBhcmVudHMsIHJlc3VsdC5jb3VudCk7XG5cbiAgICAgIGlmIChzbmFwc2hvdHNbcmVzdWx0Lm5hbWVdKSB7XG4gICAgICAgIHJlc3VsdC5leGlzdHMgPSB0cnVlO1xuICAgICAgICByZXN1bHQuY29udGVudCA9IHNuYXBzaG90c1tyZXN1bHQubmFtZV07XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0pO1xuICB9XG59XG4iXX0=